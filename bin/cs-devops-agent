#!/usr/bin/env node

/**
 * CS_DevOpsAgent CLI Entry Point
 * This is the main executable when installed via npm
 */

import { fileURLToPath } from 'url';
import { dirname, join } from 'path';
import { spawn } from 'child_process';
import fs from 'fs';
import { credentialsManager } from '../src/credentials-manager.js';

// Inject credentials immediately
credentialsManager.injectEnv();

const __filename = fileURLToPath(import.meta.url);
const __dirname = dirname(__filename);
const rootDir = join(__dirname, '..');

// Parse command line arguments
const args = process.argv.slice(2);
const command = args[0] || 'help';

// Helper function to run a script
function runScript(scriptPath, scriptArgs = []) {
  const child = spawn('node', [scriptPath, ...scriptArgs], {
    stdio: 'inherit',
    cwd: process.cwd()
  });
  
  child.on('exit', (code) => {
    process.exit(code);
  });
}

// Helper function to run a shell script
function runShellScript(scriptPath, scriptArgs = []) {
  // Detect shell based on platform
  const shell = process.platform === 'win32' ? 'bash.exe' : 'bash';
  
  const child = spawn(shell, [scriptPath, ...scriptArgs], {
    stdio: 'inherit',
    cwd: process.cwd(),
    shell: process.platform === 'win32' ? true : false
  });
  
  child.on('exit', (code) => {
    process.exit(code);
  });
}

// Command handlers
switch(command) {
  case 'start':
  case 'session':
    // Start interactive session manager
    // On Windows, always use Node.js coordinator (bash may not be available)
    if (process.platform === 'win32') {
      console.log('Starting DevOps Agent session manager...\n');
      runScript(join(rootDir, 'src', 'session-coordinator.js'), ['start', ...args.slice(1)]);
    } else {
      // Unix/Mac: use bash script
      const sessionScript = join(rootDir, 'start-devops-session.sh');
      if (fs.existsSync(sessionScript)) {
        runShellScript(sessionScript, args.slice(1));
      } else {
        console.error('Session script not found. Please ensure the package is properly installed.');
        process.exit(1);
      }
    }
    break;
    
  case 'worker':
    // Run the worker directly
    runScript(join(rootDir, 'src', 'cs-devops-agent-worker.js'), args.slice(1));
    break;
    
  case 'setup':
    // Run setup wizard
    runScript(join(rootDir, 'src', 'setup-cs-devops-agent.js'), args.slice(1));
    break;
    
  case 'worktree':
    // Manage worktrees
    runScript(join(rootDir, 'src', 'worktree-manager.js'), args.slice(1));
    break;
    
  case 'coordinator':
    // Run session coordinator
    runScript(join(rootDir, 'src', 'session-coordinator.js'), args.slice(1));
    break;
    
  case 'list':
    // List sessions
    runScript(join(rootDir, 'src', 'session-coordinator.js'), ['list']);
    break;
    
  case 'create':
    // Create new session
    runScript(join(rootDir, 'src', 'session-coordinator.js'), ['create', ...args.slice(1)]);
    break;
    
  case 'close':
    // Close session
    runScript(join(rootDir, 'src', 'close-session.js'), args.slice(1));
    break;
    
  case 'cleanup':
    // Cleanup sessions
    const cleanupScript = join(rootDir, 'cleanup-sessions.sh');
    if (fs.existsSync(cleanupScript)) {
      runShellScript(cleanupScript, args.slice(1));
    } else {
      console.error('Cleanup script not found.');
      process.exit(1);
    }
    break;
    
  case 'chat':
    // Run the chat agent
    runScript(join(rootDir, 'src', 'agent-chat.js'), args.slice(1));
    break;

  case 'creds':
    const subCmd = args[1];
    if (subCmd === 'set-groq-key') {
      const key = args[2];
      if (!key) {
        console.error('Error: Please provide a key. Usage: cs-devops-agent creds set-groq-key <key>');
        process.exit(1);
      }
      credentialsManager.setGroqApiKey(key);
      console.log('✅ Groq API Key saved securely.');
    } else if (subCmd === 'status') {
      console.log('Credentials Status:');
      console.log(`- Groq API Key: ${credentialsManager.hasGroqApiKey() ? '✅ Configured' : '❌ Missing'}`);
      console.log(`- Storage: ${credentialsManager.hasGroqApiKey() ? 'local_deploy/credentials.json' : 'N/A'}`);
    } else if (subCmd === 'clear') {
      credentialsManager.clearAll();
      console.log('✅ All credentials cleared.');
    } else {
      console.log('Usage: cs-devops-agent creds [set-groq-key <key> | status | clear]');
    }
    break;

  case 'tutorial':
    // Run interactive tutorial
    runScript(join(rootDir, 'src', 'tutorial-mode.js'), args.slice(1));
    break;
    
  case 'help-topics':
  case 'help-browser':
    // Run interactive help browser
    import(join(rootDir, 'src', 'help-system.js')).then(m => m.helpBrowser());
    break;
    
  case 'version':
  case '--version':
  case '-v':
    const packageJson = JSON.parse(fs.readFileSync(join(rootDir, 'package.json'), 'utf8'));
    console.log(`CS_DevOpsAgent v${packageJson.version}`);
    break;
    
  case 'help':
  case '--help':
  case '-h':
    console.log(`
CS_DevOpsAgent - Intelligent Git Automation System
Version: ${JSON.parse(fs.readFileSync(join(rootDir, 'package.json'), 'utf8')).version}

Usage: cs-devops-agent [command] [options]

Commands:
  start, session     Start interactive DevOps session manager
  tutorial           Run interactive tutorial (new users start here!)
  help-topics        Browse comprehensive help topics
  worker             Run the DevOps agent worker directly  
  setup              Run interactive setup wizard
  worktree           Manage git worktrees for agents
  coordinator        Session coordinator operations
  list               List all active sessions
  create             Create a new session
  close              Close an active session
  cleanup            Clean up stale sessions
  creds              Manage API credentials
  version            Show version information
  help               Show this help message

Examples:
  cs-devops-agent tutorial           # Learn how to use DevOps Agent (recommended)
  cs-devops-agent start              # Start interactive session manager
  cs-devops-agent setup              # Run first-time setup
  cs-devops-agent help-topics        # Browse comprehensive help
  cs-devops-agent list               # List active sessions
  cs-devops-agent create --task api  # Create new session for API work
  cs-devops-agent creds status       # Check API credential status

Environment Variables:
  AC_BRANCH_PREFIX     Branch prefix for daily branches
  AC_PUSH             Enable auto-push (true/false)  
  AC_DEBUG            Enable debug logging (true/false)
  AC_TZ               Timezone for daily rollover

For more information, visit: https://github.com/SecondBrainAICo/CS_DevOpsAgent
    `);
    break;

  default:
    // Default to chat if no command provided, or if unknown command
    // This replaces the prior UX where help was default
    if (!command || !command.startsWith('-')) {
      console.log('Starting Kora Smart Assistant...');
      runScript(join(rootDir, 'src', 'agent-chat.js'), args.slice(1));
    } else {
      // Show help for flags like -h, --help, or unknown flags
      console.log(`\nCS_DevOpsAgent - Intelligent Git Automation System`);
      console.log(`Usage: cs-devops-agent [command] [options]`);
      console.log(`Try 'cs-devops-agent help' for more information.`);
    }
    break;
}
